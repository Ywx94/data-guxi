name: ğŸ“ˆ æ›´æ–°è‚¡æ¯æ•°æ®

on:
  # å®šæ—¶è§¦å‘ - æ¯å¤©åŒ—äº¬æ—¶é—´æ—©ä¸Š 6 ç‚¹ (UTC 22:00)
  schedule:
    - cron: '0 22 * * *'
  
  # æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:
    inputs:
      reason:
        description: 'æ‰‹åŠ¨è§¦å‘åŸå› '
        required: false
        default: 'æ‰‹åŠ¨æ›´æ–°'

# é˜²æ­¢åŒæ—¶è¿è¡Œå¤šä¸ª
concurrency:
  group: update-dividends
  cancel-in-progress: true

jobs:
  fetch-and-update:
    runs-on: ubuntu-latest
    timeout-minutes: 120
    
    permissions:
      contents: write
    
    steps:
      - name: ğŸ“¥ æ£€å‡ºä»“åº“
        uses: actions/checkout@v4
      
      - name: ğŸŸ¢ è®¾ç½® Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: ğŸ“¦ å®‰è£…ä¾èµ–
        run: npm install
      
      - name: ğŸ”„ è·å–è‚¡æ¯æ•°æ®
        run: npm run fetch
        env:
          NODE_ENV: production
      
      - name: ğŸ“Š æ˜¾ç¤ºç»Ÿè®¡
        run: |
          echo "=== æ•°æ®ç»Ÿè®¡ ==="
          if [ -f data/dividends.json ]; then
            echo "æ–‡ä»¶å¤§å°: $(du -h data/dividends.json | cut -f1)"
            echo "è‚¡ç¥¨æ•°é‡: $(jq '.metadata.dividendStocksCount' data/dividends.json)"
            echo "æ›´æ–°æ—¶é—´: $(jq -r '.lastUpdated' data/dividends.json)"
            echo ""
            echo "=== Top 5 é«˜è‚¡æ¯è‚¡ç¥¨ ==="
            jq -r '.statistics.top10ByYield[:5][] | "\(.symbol): \(.yield)"' data/dividends.json
          else
            echo "âŒ æ•°æ®æ–‡ä»¶æœªç”Ÿæˆ"
            exit 1
          fi
      
      - name: ğŸ’¾ æäº¤å¹¶æ¨é€
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action Bot"
          
          git add data/
          
          if git diff --staged --quiet; then
            echo "ğŸ“­ æ²¡æœ‰æ•°æ®å˜åŒ–"
          else
            STOCK_COUNT=$(jq '.metadata.dividendStocksCount' data/dividends.json)
            git commit -m "ğŸ“ˆ æ›´æ–°è‚¡æ¯æ•°æ®: ${STOCK_COUNT} åªè‚¡ç¥¨ [$(date +'%Y-%m-%d')]"
            git push
            echo "âœ… æ•°æ®å·²æ›´æ–°å¹¶æ¨é€"
          fi
      
      - name: ğŸ“ ç”Ÿæˆè¿è¡Œæ‘˜è¦
        run: |
          echo "## ğŸ“ˆ è‚¡æ¯æ•°æ®æ›´æ–°æŠ¥å‘Š" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| æŒ‡æ ‡ | å€¼ |" >> $GITHUB_STEP_SUMMARY
          echo "|------|-----|" >> $GITHUB_STEP_SUMMARY
          echo "| æ›´æ–°æ—¶é—´ | $(jq -r '.lastUpdated' data/dividends.json) |" >> $GITHUB_STEP_SUMMARY
          echo "| æ‰«æè‚¡ç¥¨æ•° | $(jq '.metadata.totalScanned' data/dividends.json) |" >> $GITHUB_STEP_SUMMARY
          echo "| è‚¡æ¯è‚¡ç¥¨æ•° | $(jq '.metadata.dividendStocksCount' data/dividends.json) |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ğŸ† Top 10 é«˜è‚¡æ¯" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          jq -r '.statistics.top10ByYield[] | "\(.symbol) - \(.name): \(.yield)"' data/dividends.json >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY

  deploy-pages:
    needs: fetch-and-update
    runs-on: ubuntu-latest
    
    permissions:
      contents: read
      pages: write
      id-token: write
    
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    
    steps:
      - name: ğŸ“¥ æ£€å‡ºä»“åº“
        uses: actions/checkout@v4
        with:
          ref: main
      
      - name: ğŸ”„ æ‹‰å–æœ€æ–°æ›´æ”¹
        run: git pull origin main
      
      - name: ğŸ“„ åˆ›å»º index.html
        run: |
          cat > data/index.html << 'EOF'
          <!DOCTYPE html>
          <html>
          <head>
            <title>Data Guxi API</title>
            <meta charset="UTF-8">
            <style>
              body { font-family: -apple-system, sans-serif; max-width: 800px; margin: 50px auto; padding: 20px; }
              code { background: #f4f4f4; padding: 2px 6px; border-radius: 4px; }
              pre { background: #f4f4f4; padding: 15px; border-radius: 8px; overflow-x: auto; }
              a { color: #0066cc; }
              h1 { color: #333; }
            </style>
          </head>
          <body>
            <h1>ğŸ“ˆ Data Guxi - ç¾è‚¡è‚¡æ¯æ•°æ® API</h1>
            <p>æ¯æ—¥è‡ªåŠ¨æ›´æ–°çš„ç¾è‚¡è‚¡æ¯è‚¡ç¥¨æ•°æ®</p>
            
            <h2>ğŸ“¡ API ç«¯ç‚¹</h2>
            <ul>
              <li><a href="./dividends.json">dividends.json</a> - å®Œæ•´è‚¡æ¯æ•°æ®</li>
            </ul>
            
            <h2>ğŸ’» ä½¿ç”¨ç¤ºä¾‹</h2>
            <pre>
          fetch('https://ä½ çš„ç”¨æˆ·å.github.io/data-guxi/dividends.json')
            .then(res => res.json())
            .then(data => {
              console.log('è‚¡æ¯è‚¡ç¥¨æ•°é‡:', data.metadata.dividendStocksCount);
              console.log('Top 10:', data.statistics.top10ByYield);
            });
            </pre>
            
            <h2>ğŸ“Š æ•°æ®ç»“æ„</h2>
            <pre>
          {
            "lastUpdated": "ISOæ—¶é—´æˆ³",
            "metadata": { ... },
            "statistics": { ... },
            "stocks": [ ... ]
          }
            </pre>
            
            <p>â° æ•°æ®æ›´æ–°æ—¶é—´ï¼šæ¯å¤©åŒ—äº¬æ—¶é—´ 6:00</p>
          </body>
          </html>
          EOF
      
      - name: âš™ï¸ é…ç½® Pages
        uses: actions/configure-pages@v4
      
      - name: ğŸ“¤ ä¸Šä¼ åˆ° Pages
        uses: actions/upload-pages-artifact@v3
        with:
          path: 'data'
      
      - name: ğŸš€ éƒ¨ç½² Pages
        id: deployment
        uses: actions/deploy-pages@v4