name: ğŸ“ˆ æ›´æ–°è‚¡æ¯æ•°æ®

on:
  schedule:
    - cron: '0 22 * * *'
  workflow_dispatch:

concurrency:
  group: update-dividends
  cancel-in-progress: true

jobs:
  fetch-and-update:
    runs-on: ubuntu-latest
    timeout-minutes: 180
    
    permissions:
      contents: write
    
    steps:
      - name: ğŸ“¥ æ£€å‡ºä»“åº“
        uses: actions/checkout@v4
      
      - name: ğŸŸ¢ è®¾ç½® Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: ğŸ“¦ å®‰è£…ä¾èµ–
        run: npm install
      
      - name: ğŸ”„ è·å–è‚¡æ¯æ•°æ®
        run: npm run fetch
        env:
          NODE_ENV: production
      
      - name: ğŸ“Š æ˜¾ç¤ºç»Ÿè®¡
        run: |
          echo "=== æ•°æ®ç»Ÿè®¡ ==="
          if [ -f data/dividends.json ]; then
            echo "æ–‡ä»¶å¤§å°: $(du -h data/dividends.json | cut -f1)"
            echo "è‚¡ç¥¨æ•°é‡: $(jq '.stats.totalDividendStocks' data/dividends.json)"
            echo "æ›´æ–°æ—¶é—´: $(jq -r '.lastUpdated' data/dividends.json)"
            echo "æœ‰å¢é•¿ç‡: $(jq '.stats.withGrowthData' data/dividends.json)"
            echo "æ— å¢é•¿ç‡: $(jq '.stats.withoutGrowthData' data/dividends.json)"
            echo ""
            echo "=== Top 5 é«˜è‚¡æ¯è‚¡ç¥¨ ==="
            jq -r '.stocks[:5][] | "\(.symbol): \(.dividendYield) (å¢é•¿: \(.growthRate))"' data/dividends.json
          else
            echo "âŒ æ•°æ®æ–‡ä»¶æœªç”Ÿæˆ"
            exit 1
          fi
      
      - name: ğŸ’¾ æäº¤å¹¶æ¨é€
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action Bot"
          
          git add data/
          
          if git diff --staged --quiet; then
            echo "ğŸ“­ æ²¡æœ‰æ•°æ®å˜åŒ–"
          else
            STOCK_COUNT=$(jq '.stats.totalDividendStocks' data/dividends.json)
            git commit -m "ğŸ“ˆ æ›´æ–°è‚¡æ¯æ•°æ®: ${STOCK_COUNT} åªè‚¡ç¥¨ [$(date +'%Y-%m-%d')]"
            git push
            echo "âœ… æ•°æ®å·²æ›´æ–°å¹¶æ¨é€"
          fi
      
      - name: ğŸ“ ç”Ÿæˆè¿è¡Œæ‘˜è¦
        run: |
          echo "## ğŸ“ˆ è‚¡æ¯æ•°æ®æ›´æ–°æŠ¥å‘Š" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| æŒ‡æ ‡ | å€¼ |" >> $GITHUB_STEP_SUMMARY
          echo "|------|-----|" >> $GITHUB_STEP_SUMMARY
          echo "| æ›´æ–°æ—¶é—´ | $(jq -r '.lastUpdated' data/dividends.json) |" >> $GITHUB_STEP_SUMMARY
          echo "| æ‰«æè‚¡ç¥¨æ•° | $(jq '.totalScanned' data/dividends.json) |" >> $GITHUB_STEP_SUMMARY
          echo "| è‚¡æ¯è‚¡ç¥¨æ•° | $(jq '.stats.totalDividendStocks' data/dividends.json) |" >> $GITHUB_STEP_SUMMARY
          echo "| æœ‰å¢é•¿ç‡ | $(jq '.stats.withGrowthData' data/dividends.json) |" >> $GITHUB_STEP_SUMMARY
          echo "| æ— å¢é•¿ç‡ | $(jq '.stats.withoutGrowthData' data/dividends.json) |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ğŸ† Top 10 é«˜è‚¡æ¯" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          jq -r '.stocks[:10][] | "\(.symbol) - \(.name): \(.dividendYield) (å¢é•¿: \(.growthRate))"' data/dividends.json >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY

  deploy-pages:
    needs: fetch-and-update
    runs-on: ubuntu-latest
    
    permissions:
      contents: read
      pages: write
      id-token: write
    
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    
    steps:
      - name: ğŸ“¥ æ£€å‡ºä»“åº“
        uses: actions/checkout@v4
        with:
          ref: main
      
      - name: ğŸ”„ æ‹‰å–æœ€æ–°æ›´æ”¹
        run: git pull origin main
      
      - name: ğŸ“„ åˆ›å»º index.html
        run: |
          cat > data/index.html << 'EOF'
          <!DOCTYPE html>
          <html>
          <head>
            <title>Data Guxi API</title>
            <meta charset="UTF-8">
            <style>
              body { font-family: -apple-system, sans-serif; max-width: 800px; margin: 50px auto; padding: 20px; }
              pre { background: #f4f4f4; padding: 15px; border-radius: 8px; overflow-x: auto; }
              a { color: #0066cc; }
            </style>
          </head>
          <body>
            <h1>ğŸ“ˆ Data Guxi - ç¾è‚¡è‚¡æ¯æ•°æ® API</h1>
            <p>æ¯æ—¥è‡ªåŠ¨æ›´æ–°çš„ç¾è‚¡è‚¡æ¯è‚¡ç¥¨æ•°æ®</p>
            <h2>ğŸ“¡ API ç«¯ç‚¹</h2>
            <ul>
              <li><a href="./dividends.json">dividends.json</a> - å®Œæ•´è‚¡æ¯æ•°æ®</li>
            </ul>
            <p>â° æ•°æ®æ›´æ–°æ—¶é—´ï¼šæ¯å¤©åŒ—äº¬æ—¶é—´ 6:00</p>
          </body>
          </html>
          EOF
      
      - name: âš™ï¸ é…ç½® Pages
        uses: actions/configure-pages@v4
      
      - name: ğŸ“¤ ä¸Šä¼ åˆ° Pages
        uses: actions/upload-pages-artifact@v3
        with:
          path: 'data'
      
      - name: ğŸš€ éƒ¨ç½² Pages
        id: deployment
        uses: actions/deploy-pages@v4